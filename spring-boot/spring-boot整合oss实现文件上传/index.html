<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analytics、Baidu-Tongji)-->
<head>
  <!-- Google Analytics -->
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-156566359-1"></script>
  <script type="text/javascript">
    window.dataLayer = window.dataLayer || [];

    function gtag() {
      dataLayer.push(arguments);
    }
    gtag('js', new Date());

    gtag('config', 'UA-156566359-1');
  </script>
  

  <!-- Baidu Tongji -->
  
  <script type="text/javascript">
    // Originial
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?33a6f7188727e0d8cfcd3b7f9452dc31";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>
  

  <!-- Baidu Push -->
  
  <script>
    (function() {
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
      } else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>
  
  
  <!-- 百度收录 -->
  <meta name="baidu-site-verification" content="2ZDUVsGbxv" />
	
  <!-- 必应收录 -->
  <meta name="msvalidate.01" content="4C242012E561A50DD0F3102944B63EF1" />
	
  <!-- 谷歌收录 -->
  <meta name="google-site-verification" content="4e3rzgnN4CHtInkIMy3mvlBryDcdtTOhXsNbonAKdlE" />
  
  <!-- 搜狗收录 -->
  <meta name="sogou_site_verification" content="WYbhVYjWME"/>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc" />
  <meta name="baidu-site-verification" content="PpzM9WxOJU" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="本站是彭超的个人博客，内容涵盖生活故事、优质书籍、编程技术等等。" />
  <meta name="keywords" content="彭超,彭超博客,彭超的博客,彭超的网站,暮夏有五,软件开发,网站建设,微信开发,小程序开发,APP开发" />
  <link rel="shortcut icon" href="https://qiniuyun.antoniopeng.com/favicon.ico" />

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>
  <!-- Bootstrap Core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css" />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/css/beantech.min.css" />

  <!-- Pygments Highlight CSS -->
  
<link rel="stylesheet" href="../../css/highlight.css">
<link rel="stylesheet" href="../../css/widget.css">
<link rel="stylesheet" href="../../css/rocket.css">
<link rel="stylesheet" href="../../css/signature.css">
<link rel="stylesheet" href="../../css/catalog.css">
<link rel="stylesheet" href="../../css/livemylife.css">


  
  <!-- wave start -->
  <link rel="stylesheet" href="/css/wave.css" />
  <!-- wave end -->
  

  
  <!-- top start (article top hot config) -->
  <link rel="stylesheet" href="/css/top.css" />
  <!-- top end -->
  

  
  <!-- ThemeColor start -->
  <link rel="stylesheet" href="/css/scroll.css" />
  <!-- ThemeColor end -->
  

  
  <!-- viewer start (Picture preview) -->
  <link rel="stylesheet" href="/css/viewer.min.css" />
  <!-- viewer end -->
  

  
  <!-- Search start -->
  <link rel="stylesheet" href="/css/search.css" />
  <!-- Search end -->
  

  
  <!-- ThemeColor start -->
  <link rel="stylesheet" href="/css/themecolor.css" />
  <!-- ThemeColor end -->
  

  

  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
    href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="https://antoniopeng.com/spring-boot/spring-boot整合oss实现文件上传/">
  <title>
    
    Spring Boot 整合 OSS 实现文件上传 - 彭超的博客 | Antonio Blog
    
  </title>
<meta name="generator" content="Hexo 4.2.1"></head>


<!-- hack iOS CSS :active style -->

<body ontouchstart="" class="body--home">
	<!-- ThemeColor -->
	
	<!-- ThemeColor -->
<!-- <div class="toggle" onclick="document.body.classList.toggle('body--dark')">Switch Color</div> -->

<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons bright-mode"></i>
  <i class="mdui-icon material-icons dark-mode"></i>
</div>

	

	<!-- Gitter -->
	
	<!-- Gitter -->
<!-- Docs:https://gitter.im/?utm_source=left-menu-logo -->
<script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'antoniopeng/developer'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

	

	<!-- Navigation (contains search)-->
	<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">彭超</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">Home</a>
          </li>

          

          
          

          
          <li>
            <a href="/archive/">Archives</a>
          </li>
          
          

          
          <li>
            <a href="/categories/">Categories</a>
          </li>
          
          

          
          <li>
            <a href="/tags/">Tags</a>
          </li>
          
          

          
          <li><a class="popup-trigger" title="Search"><span class="search-icon"></span>Search</a></li>
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>


<script>
  // Drop Bootstarp low-performance Navbar
  // Use customize navbar with high-quality material design animation
  // in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


	<!-- Post Header (contains intro-header、signature、wordcount、busuanzi、waveoverlay) -->
	<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <style type="text/css">
    header.intro-header {
       /*post*/
        background-image: url('https://qiniuyun.antoniopeng.com/work.jpg');
      
    }

    
      #signature {/*signature*/
        background-image: url('https://qiniuyun.antoniopeng.com/fb23ac446ba7e70f8479baf98c8dd130.jpg');
      }
    
  </style>





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading">
            <div class="tags">
              
              <a class="tag" href="https://antoniopeng.com/tags/#Spring Boot" title="Spring Boot">Spring Boot</a>
              
            </div>
            <h1>Spring Boot 整合 OSS 实现文件上传</h1>
            <h2 class="subheading"></h2>
            <span class="meta">
              Posted by 暮夏有五 on
              2021-01-23
            </span>


            
            <!-- WordCount start -->
            <div class="blank_box"></div>
            <span class="meta">
              Estimated Reading Time <span class="post-count">8</span> Minutes
            </span>
            <div class="blank_box"></div>
            <span class="meta">
              Words <span class="post-count">2k</span> In Total
            </span>
            <div class="blank_box"></div>
            <!-- 不蒜子统计 start -->
            <span class="meta">
              Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
            </span>
            <!-- 不蒜子统计 end -->
            <!-- WordCount end -->
            


          </div>
          
        </div>
      </div>
    </div>
  </div>

  
  <!-- waveoverlay start -->
  <div class="preview-overlay">
    <svg class="preview-waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
      <defs>
        <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path>
      </defs>
      <g class="preview-parallax">
        <use xlink:href="#gentle-wave" x="48" y="0" fill=var(--gentle-wave1)></use>
        <use xlink:href="#gentle-wave" x="48" y="3" fill=var(--gentle-wave2)></use>
        <use xlink:href="#gentle-wave" x="48" y="5" fill=var(--gentle-wave3)></use>
        <use xlink:href="#gentle-wave" x="48" y="7" fill=var(--gentle-wave)></use>
      </g>
    </svg>
  </div>
  <!-- waveoverlay end -->
  

</header>



	<!-- Main Content (Post contains
	Pager、
	tip、
	socialshare、
	gitalk、gitment、disqus-comment、
	Catalog、
	Sidebar、
	Featured-Tags、
	Friends Blog、
	anchorjs、
	) -->
	<!-- Modify by Yu-Hsuan Yen -->
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

		<!-- <a href="https://s.click.taobao.com/HoalEtu" target="_blank" rel="noopener" ><img src="https://qiniuyun.antoniopeng.com/advertisement01.jpg"/></a> -->

        <p>本文主要讲解整合 OSS 实现文件上传的过程，采用的是服务端签名后前端直传的方式。阿里云对象存储服务（Object Storage Service，简称OSS），是阿里云提供的海量、安全、低成本、高可靠的云存储服务。OSS 可用于图片、音视频、日志等海量文件的存储。各种终端设备、Web 网站程序、移动应用可以直接向 OSS 写入或读取数据。</p>
<h3 id="OSS-简介"><a href="#OSS-简介" class="headerlink" title="OSS 简介"></a>OSS 简介</h3><hr />

<p>阿里云对象存储服务（Object Storage Service，简称 OSS），是阿里云提供的海量、安全、低成本、高可靠的云存储服务。OSS 可用于图片、音视频、日志等海量文件的存储。各种终端设备、Web网站程序、移动应用可以直接向 OSS 写入或读取数据。</p>
<h4 id="OSS中的相关概念"><a href="#OSS中的相关概念" class="headerlink" title="OSS中的相关概念"></a>OSS中的相关概念</h4><ul>
<li><code>Endpoint</code>：访问域名，通过该域名可以访问OSS服务的API，进行文件上传、下载等操作。</li>
<li><code>Bucket</code>：存储空间，是存储对象的容器，所有存储对象都必须隶属于某个存储空间。</li>
<li><code>Object</code>：对象，对象是 OSS 存储数据的基本单元，也被称为 OSS 的文件。</li>
<li><code>AccessKey</code>：访问密钥，指的是访问身份验证中用到的 AccessKeyId 和 AccessKeySecret。</li>
</ul>
<h3 id="OSS的相关设置"><a href="#OSS的相关设置" class="headerlink" title="OSS的相关设置"></a>OSS的相关设置</h3><hr />

<h4 id="开通-OSS-服务"><a href="#开通-OSS-服务" class="headerlink" title="开通 OSS 服务"></a>开通 OSS 服务</h4><ul>
<li>登录阿里云官网；</li>
<li>将鼠标移至产品标签页，单击对象存储 OSS，打开 OSS 产品详情页面；</li>
<li>在 OSS 产品详情页，单击立即开通。</li>
</ul>
<h4 id="创建存储空间"><a href="#创建存储空间" class="headerlink" title="创建存储空间"></a>创建存储空间</h4><p>点击网页右上角控制台按钮进入控制台：</p>
<p><img src="https://qiniuyun.antoniopeng.com/spring-boot%E6%95%B4%E5%90%88oss%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A001.png" alt="img"></p>
<p>选择我的云产品中的对象存储 OSS：</p>
<p><img src="https://qiniuyun.antoniopeng.com/spring-boot%E6%95%B4%E5%90%88oss%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A002.png" alt="img"></p>
<p>点击左侧存储空间的加号新建存储空间：</p>
<p><img src="https://qiniuyun.antoniopeng.com/spring-boot%E6%95%B4%E5%90%88oss%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A003.png" alt="img"></p>
<p>新建存储空间并设置读写权限为公共读：</p>
<p><img src="https://qiniuyun.antoniopeng.com/spring-boot%E6%95%B4%E5%90%88oss%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A004.png" alt="img"></p>
<h4 id="跨域资源共享（CORS）的设置"><a href="#跨域资源共享（CORS）的设置" class="headerlink" title="跨域资源共享（CORS）的设置"></a>跨域资源共享（CORS）的设置</h4><p>由于浏览器处于安全考虑，不允许跨域资源访问，所以我们要设置 OSS 的跨域资源共享。</p>
<p>选择一个存储空间，打开其基础设置：</p>
<p><img src="https://qiniuyun.antoniopeng.com/spring-boot%E6%95%B4%E5%90%88oss%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A005.png" alt="img"></p>
<p>点击跨越设置的设置按钮：</p>
<p><img src="https://qiniuyun.antoniopeng.com/spring-boot%E6%95%B4%E5%90%88oss%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A006.png" alt="img"></p>
<p>点击创建规则：</p>
<p><img src="https://qiniuyun.antoniopeng.com/spring-boot%E6%95%B4%E5%90%88oss%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A007.png" alt="img"></p>
<p>进行跨域规则设置：</p>
<p><img src="https://qiniuyun.antoniopeng.com/spring-boot%E6%95%B4%E5%90%88oss%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A008.png" alt="img"></p>
<h4 id="服务端签名后前端直传的相关说明"><a href="#服务端签名后前端直传的相关说明" class="headerlink" title="服务端签名后前端直传的相关说明"></a>服务端签名后前端直传的相关说明</h4><p><strong>流程示例图</strong></p>
<p><img src="https://qiniuyun.antoniopeng.com/spring-boot%E6%95%B4%E5%90%88oss%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A009.png" alt="img"></p>
<p><strong>流程介绍</strong></p>
<ol>
<li>Web前端请求应用服务器，获取上传所需参数（如 OSS 的 accessKeyId、policy、callback 等参数）</li>
<li>应用服务器返回相关参数</li>
<li>Web前端直接向 OSS 服务发起上传文件请求</li>
<li>等上传完成后 OSS 服务会回调应用服务器的回调接口</li>
<li>应用服务器返回响应给 OSS 服务</li>
<li>OSS 服务将应用服务器回调接口的内容返回给 Web 前端</li>
</ol>
<h3 id="整合-OSS-实现文件上传"><a href="#整合-OSS-实现文件上传" class="headerlink" title="整合 OSS 实现文件上传"></a>整合 OSS 实现文件上传</h3><hr />

<h4 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h4><p>在 pom.xml 中添加相关依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- OSS SDK 相关依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.aliyun.oss<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aliyun-sdk-oss<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="相关配置"><a href="#相关配置" class="headerlink" title="相关配置"></a>相关配置</h4><p>修改 application.yml 文件，添加 OSS 相关配置。</p>
<p><strong>注意：</strong>endpoint、accessKeyId、accessKeySecret、bucketName、callback、prefix 都要改为你自己帐号 OSS 相关的，callback 需要是公网可以访问的地址。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># OSS相关配置信息</span></span><br><span class="line"><span class="attr">aliyun:</span></span><br><span class="line">  <span class="attr">oss:</span></span><br><span class="line">    <span class="attr">endpoint:</span> <span class="string">oss-cn-shenzhen.aliyuncs.com</span> <span class="comment"># oss对外服务的访问域名</span></span><br><span class="line">    <span class="attr">accessKeyId:</span> <span class="string">test</span> <span class="comment"># 访问身份验证中用到用户标识</span></span><br><span class="line">    <span class="attr">accessKeySecret:</span> <span class="string">test</span> <span class="comment"># 用户用于加密签名字符串和oss用来验证签名字符串的密钥</span></span><br><span class="line">    <span class="attr">bucketName:</span> <span class="string">macro-oss</span> <span class="comment"># oss的存储空间</span></span><br><span class="line">    <span class="attr">policy:</span></span><br><span class="line">      <span class="attr">expire:</span> <span class="number">300</span> <span class="comment"># 签名有效期(S)</span></span><br><span class="line">    <span class="attr">maxSize:</span> <span class="number">10</span> <span class="comment"># 上传文件大小(M)</span></span><br><span class="line">    <span class="attr">callback:</span> <span class="string">http://localhost:8080/aliyun/oss/callback</span> <span class="comment"># 文件上传成功后的回调地址</span></span><br><span class="line">    <span class="attr">dir:</span></span><br><span class="line">      <span class="attr">prefix:</span> <span class="string">mall/images/</span> <span class="comment"># 上传文件夹路径前缀</span></span><br></pre></td></tr></table></figure>

<p>创建 OSS 的相关 Java 配置，用于配置 OSS 的连接客户端 OSSClient：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OssConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;aliyun.oss.endpoint&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String ALIYUN_OSS_ENDPOINT;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;aliyun.oss.accessKeyId&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String ALIYUN_OSS_ACCESSKEYID;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;aliyun.oss.accessKeySecret&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String ALIYUN_OSS_ACCESSKEYSECRET;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OSSClient <span class="title">ossClient</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OSSClient(ALIYUN_OSS_ENDPOINT,ALIYUN_OSS_ACCESSKEYID,ALIYUN_OSS_ACCESSKEYSECRET);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建 OSS 上传策略封装对象 OssPolicyResult，前端直接上传文件时所需参数，从后端返回过来。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取OSS上传文件授权返回结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OssPolicyResult</span> </span>&#123;</span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(<span class="string">"访问身份验证中用到用户标识"</span>)</span><br><span class="line">    <span class="keyword">private</span> String accessKeyId;</span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(<span class="string">"用户表单上传的策略,经过base64编码过的字符串"</span>)</span><br><span class="line">    <span class="keyword">private</span> String policy;</span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(<span class="string">"对policy签名后的字符串"</span>)</span><br><span class="line">    <span class="keyword">private</span> String signature;</span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(<span class="string">"上传文件夹路径前缀"</span>)</span><br><span class="line">    <span class="keyword">private</span> String dir;</span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(<span class="string">"oss对外服务的访问域名"</span>)</span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(<span class="string">"上传成功后的回调设置"</span>)</span><br><span class="line">    <span class="keyword">private</span> String callback;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//省略了所有getter,setter方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建 OSS 上传成功后的回调参数对象 OssCallbackParam，当 OSS 上传成功后，会根据该配置参数来回调对应接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * OSS 上传成功后的回调参数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OssCallbackParam</span> </span>&#123;</span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(<span class="string">"请求的回调地址"</span>)</span><br><span class="line">    <span class="keyword">private</span> String callbackUrl;</span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(<span class="string">"回调是传入request中的参数"</span>)</span><br><span class="line">    <span class="keyword">private</span> String callbackBody;</span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(<span class="string">"回调时传入参数的格式，比如表单提交形式"</span>)</span><br><span class="line">    <span class="keyword">private</span> String callbackBodyType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//省略了所有getter,setter方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="创建-OSS-回调结果对象"><a href="#创建-OSS-回调结果对象" class="headerlink" title="创建 OSS 回调结果对象"></a>创建 OSS 回调结果对象</h4><p>创建  OssCallbackResult 类封装了上传文件的信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * oss上传文件的回调结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OssCallbackResult</span> </span>&#123;</span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(<span class="string">"文件名称"</span>)</span><br><span class="line">    <span class="keyword">private</span> String filename;</span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(<span class="string">"文件大小"</span>)</span><br><span class="line">    <span class="keyword">private</span> String size;</span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(<span class="string">"文件的mimeType"</span>)</span><br><span class="line">    <span class="keyword">private</span> String mimeType;</span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(<span class="string">"图片文件的宽"</span>)</span><br><span class="line">    <span class="keyword">private</span> String width;</span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(<span class="string">"图片文件的高"</span>)</span><br><span class="line">    <span class="keyword">private</span> String height;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//省略了所有getter,setter方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="创建-OSS-业务接口"><a href="#创建-OSS-业务接口" class="headerlink" title="创建 OSS 业务接口"></a>创建 OSS 业务接口</h4><p>创建  OssService 接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * oss上传管理Service</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OssService</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * oss上传策略生成</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">OssPolicyResult <span class="title">policy</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * oss上传成功回调</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">OssCallbackResult <span class="title">callback</span><span class="params">(HttpServletRequest request)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="创建-OSS-业务接口实现类"><a href="#创建-OSS-业务接口实现类" class="headerlink" title="创建 OSS 业务接口实现类"></a>创建 OSS 业务接口实现类</h4><p>创建 OssServiceImpl 接口实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * oss上传管理Service实现类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OssServiceImpl</span> <span class="keyword">implements</span> <span class="title">OssService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(OssServiceImpl<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">	<span class="meta">@Value</span>(<span class="string">"$&#123;aliyun.oss.policy.expire&#125;"</span>)</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> ALIYUN_OSS_EXPIRE;</span><br><span class="line">	<span class="meta">@Value</span>(<span class="string">"$&#123;aliyun.oss.maxSize&#125;"</span>)</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> ALIYUN_OSS_MAX_SIZE;</span><br><span class="line">	<span class="meta">@Value</span>(<span class="string">"$&#123;aliyun.oss.callback&#125;"</span>)</span><br><span class="line">	<span class="keyword">private</span> String ALIYUN_OSS_CALLBACK;</span><br><span class="line">	<span class="meta">@Value</span>(<span class="string">"$&#123;aliyun.oss.bucketName&#125;"</span>)</span><br><span class="line">	<span class="keyword">private</span> String ALIYUN_OSS_BUCKET_NAME;</span><br><span class="line">	<span class="meta">@Value</span>(<span class="string">"$&#123;aliyun.oss.endpoint&#125;"</span>)</span><br><span class="line">	<span class="keyword">private</span> String ALIYUN_OSS_ENDPOINT;</span><br><span class="line">	<span class="meta">@Value</span>(<span class="string">"$&#123;aliyun.oss.dir.prefix&#125;"</span>)</span><br><span class="line">	<span class="keyword">private</span> String ALIYUN_OSS_DIR_PREFIX;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> OSSClient ossClient;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 签名生成</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> OssPolicyResult <span class="title">policy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		OssPolicyResult result = <span class="keyword">new</span> OssPolicyResult();</span><br><span class="line">		<span class="comment">// 存储目录</span></span><br><span class="line">		SimpleDateFormat sdf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMdd"</span>);</span><br><span class="line">		String dir = ALIYUN_OSS_DIR_PREFIX+sdf.format(<span class="keyword">new</span> Date());</span><br><span class="line">		<span class="comment">// 签名有效期</span></span><br><span class="line">		<span class="keyword">long</span> expireEndTime = System.currentTimeMillis() + ALIYUN_OSS_EXPIRE * <span class="number">1000</span>;</span><br><span class="line">		Date expiration = <span class="keyword">new</span> Date(expireEndTime);</span><br><span class="line">		<span class="comment">// 文件大小</span></span><br><span class="line">		<span class="keyword">long</span> maxSize = ALIYUN_OSS_MAX_SIZE * <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line">		<span class="comment">// 回调</span></span><br><span class="line">		OssCallbackParam callback = <span class="keyword">new</span> OssCallbackParam();</span><br><span class="line">		callback.setCallbackUrl(ALIYUN_OSS_CALLBACK);</span><br><span class="line">		callback.setCallbackBody(<span class="string">"filename=$&#123;object&#125;&amp;size=$&#123;size&#125;&amp;mimeType=$&#123;mimeType&#125;&amp;height=$&#123;imageInfo.height&#125;&amp;width=$&#123;imageInfo.width&#125;"</span>);</span><br><span class="line">		callback.setCallbackBodyType(<span class="string">"application/x-www-form-urlencoded"</span>);</span><br><span class="line">		<span class="comment">// 提交节点</span></span><br><span class="line">		String action = <span class="string">"http://"</span> + ALIYUN_OSS_BUCKET_NAME + <span class="string">"."</span> + ALIYUN_OSS_ENDPOINT;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			PolicyConditions policyConds = <span class="keyword">new</span> PolicyConditions();</span><br><span class="line">			policyConds.addConditionItem(PolicyConditions.COND_CONTENT_LENGTH_RANGE, <span class="number">0</span>, maxSize);</span><br><span class="line">			policyConds.addConditionItem(MatchMode.StartWith, PolicyConditions.COND_KEY, dir);</span><br><span class="line">			String postPolicy = ossClient.generatePostPolicy(expiration, policyConds);</span><br><span class="line">			<span class="keyword">byte</span>[] binaryData = postPolicy.getBytes(<span class="string">"utf-8"</span>);</span><br><span class="line">			String policy = BinaryUtil.toBase64String(binaryData);</span><br><span class="line">			String signature = ossClient.calculatePostSignature(postPolicy);</span><br><span class="line">			String callbackData = BinaryUtil.toBase64String(JSONUtil.parse(callback).toString().getBytes(<span class="string">"utf-8"</span>));</span><br><span class="line">			<span class="comment">// 返回结果</span></span><br><span class="line">			result.setAccessKeyId(ossClient.getCredentialsProvider().getCredentials().getAccessKeyId());</span><br><span class="line">			result.setPolicy(policy);</span><br><span class="line">			result.setSignature(signature);</span><br><span class="line">			result.setDir(dir);</span><br><span class="line">			result.setCallback(callbackData);</span><br><span class="line">			result.setHost(action);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			LOGGER.error(<span class="string">"签名生成失败"</span>, e);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> OssCallbackResult <span class="title">callback</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">		OssCallbackResult result= <span class="keyword">new</span> OssCallbackResult();</span><br><span class="line">		String filename = request.getParameter(<span class="string">"filename"</span>);</span><br><span class="line">		filename = <span class="string">"http://"</span>.concat(ALIYUN_OSS_BUCKET_NAME).concat(<span class="string">"."</span>).concat(ALIYUN_OSS_ENDPOINT).concat(<span class="string">"/"</span>).concat(filename);</span><br><span class="line">		result.setFilename(filename);</span><br><span class="line">		result.setSize(request.getParameter(<span class="string">"size"</span>));</span><br><span class="line">		result.setMimeType(request.getParameter(<span class="string">"mimeType"</span>));</span><br><span class="line">		result.setWidth(request.getParameter(<span class="string">"width"</span>));</span><br><span class="line">		result.setHeight(request.getParameter(<span class="string">"height"</span>));</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="创建-OSS-控制器"><a href="#创建-OSS-控制器" class="headerlink" title="创建 OSS 控制器"></a>创建 OSS 控制器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * OSS 相关操作接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@Api</span>(tags = <span class="string">"OssController"</span>, description = <span class="string">"OSS 管理"</span>)</span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/aliyun/oss"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OssController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OssServiceImpl ossService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation</span>(value = <span class="string">"OSS 上传签名生成"</span>)</span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/policy"</span>, method = RequestMethod.GET)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult&lt;OssPolicyResult&gt; <span class="title">policy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        OssPolicyResult result = ossService.policy();</span><br><span class="line">        <span class="keyword">return</span> CommonResult.success(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation</span>(value = <span class="string">"OSS 上传成功回调"</span>)</span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"callback"</span>, method = RequestMethod.POST)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult&lt;OssCallbackResult&gt; <span class="title">callback</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        OssCallbackResult ossCallbackResult = ossService.callback(request);</span><br><span class="line">        <span class="keyword">return</span> CommonResult.success(ossCallbackResult);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="进行接口测试"><a href="#进行接口测试" class="headerlink" title="进行接口测试"></a>进行接口测试</h3><hr />

<p><img src="https://qiniuyun.antoniopeng.com/spring-boot%E6%95%B4%E5%90%88oss%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A010.png" alt="img"></p>
<p><img src="https://qiniuyun.antoniopeng.com/spring-boot%E6%95%B4%E5%90%88oss%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A011.png" alt="img"></p>
<p><img src="https://qiniuyun.antoniopeng.com/spring-boot%E6%95%B4%E5%90%88oss%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A012.png" alt="img"></p>
<p>上传会调用两次请求，第一次访问本地接口获取上传的策略：</p>
<p><img src="https://qiniuyun.antoniopeng.com/spring-boot%E6%95%B4%E5%90%88oss%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A013.png" alt="img"></p>
<p><img src="https://qiniuyun.antoniopeng.com/spring-boot%E6%95%B4%E5%90%88oss%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A014.png" alt="img"></p>
<p>第二次调用 OSS 服务的接口进行文件上传：</p>
<p><img src="https://qiniuyun.antoniopeng.com/spring-boot%E6%95%B4%E5%90%88oss%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A015.png" alt="img"></p>
<p><img src="https://qiniuyun.antoniopeng.com/spring-boot%E6%95%B4%E5%90%88oss%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A016.png" alt="img"></p>
<p>可以看到上面接口调用并没有传入回调参数 callback，所以接口返回了 204 no content，这次我们传入回调参数 callback 试试，可以发现 OSS 服务回调了我们自己定义的回调接口，并返回了相应结果：</p>
<p><img src="https://qiniuyun.antoniopeng.com/spring-boot%E6%95%B4%E5%90%88oss%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A017.png" alt="img"></p>
<p><img src="https://qiniuyun.antoniopeng.com/spring-boot%E6%95%B4%E5%90%88oss%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A018.png" alt="img"></p>
<p><img src="https://qiniuyun.antoniopeng.com/spring-boot%E6%95%B4%E5%90%88oss%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A019.png" alt="img"></p>
<blockquote>
<p>更多干货请移步：<a href="https://antoniopeng.com">https://antoniopeng.com</a></p>
</blockquote>


        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          <li class="previous">
            <a href="/spring-boot/spring-boot项目配置https安全证书/" data-toggle="tooltip" data-placement="top" title="Spring Boot 项目配置 HTTPS 安全证书">&larr; Previous Post</a>
          </li>
          
          
          <li class="next">
            <a href="/spring-boot/spring-boot整合spring-security&jwt实现认证和授权/" data-toggle="tooltip" data-placement="top" title="Spring Boot 整合 Spring Security & JWT 实现认证和授权">Next Post &rarr;</a>
          </li>
          
        </ul>

        
        <!-- tip start -->
        <div class="tip">
          <p>
            If you like this blog or find it useful for you, you are welcome to comment on it. You are also welcome to share this blog, so that more people can participate in it. If the images used in the blog infringe your copyright, please contact the author to delete them. Thank you !
          </p>
        </div>
        <!-- tip end -->
        

        
        <!-- Sharing Srtart -->
        <!-- Social Social Share Post -->
<!-- Docs:https://github.com/overtrue/share.js -->

<div class="social-share" data-initialized="true" data-disabled="tencent ,douban ,qzone ,linkedin ,facebook ,google ,diandian" data-wechat-qrcode-helper="" align="center">
  <ul class="list-inline text-center social-share-ul">
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-twitter">
        <i class="fa fa-twitter fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a class="social-share-icon icon-wechat">
        <i class="fa fa-weixin fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-weibo">
        <i class="fa fa-weibo fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-qq">
        <i class="fa fa-qq fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon" href="mailto:?subject=Spring Boot 整合 OSS 实现文件上传&body=Hi,I found this website and thought you might like it https://antoniopeng.com/spring-boot/spring-boot整合oss实现文件上传/">
        <i class="fa fa-envelope fa-1x" aria-hidden="true"></i>
      </a>
    </li>
  </ul>
</div>

<!-- css & js -->
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css"> -->
<script defer="defer" async="true" src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

        <!-- Sharing End -->
        
        <hr>

        <!-- comments start -->
        <!-- 1. gitalk comment -->




<!-- 2. gitment comment -->



<!-- 3. disqus comment -->


        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#OSS-简介"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">OSS 简介</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#OSS中的相关概念"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">OSS中的相关概念</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#OSS的相关设置"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">OSS的相关设置</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#开通-OSS-服务"><span class="toc-nav-number">2.1.</span> <span class="toc-nav-text">开通 OSS 服务</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#创建存储空间"><span class="toc-nav-number">2.2.</span> <span class="toc-nav-text">创建存储空间</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#跨域资源共享（CORS）的设置"><span class="toc-nav-number">2.3.</span> <span class="toc-nav-text">跨域资源共享（CORS）的设置</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#服务端签名后前端直传的相关说明"><span class="toc-nav-number">2.4.</span> <span class="toc-nav-text">服务端签名后前端直传的相关说明</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#整合-OSS-实现文件上传"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">整合 OSS 实现文件上传</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#引入依赖"><span class="toc-nav-number">3.1.</span> <span class="toc-nav-text">引入依赖</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#相关配置"><span class="toc-nav-number">3.2.</span> <span class="toc-nav-text">相关配置</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#创建-OSS-回调结果对象"><span class="toc-nav-number">3.3.</span> <span class="toc-nav-text">创建 OSS 回调结果对象</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#创建-OSS-业务接口"><span class="toc-nav-number">3.4.</span> <span class="toc-nav-text">创建 OSS 业务接口</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#创建-OSS-业务接口实现类"><span class="toc-nav-number">3.5.</span> <span class="toc-nav-text">创建 OSS 业务接口实现类</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#创建-OSS-控制器"><span class="toc-nav-number">3.6.</span> <span class="toc-nav-text">创建 OSS 控制器</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#进行接口测试"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">进行接口测试</span></a></li></ol>
        
        </div>
      </aside>
    


      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">FEATURED TAGS</a>
          </h5>
          <div class="tags">
            
            <a class="tag" href="/tags/#Spring Boot" title="Spring Boot">Spring Boot</a>
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
        <hr>
        <h5>FRIENDS</h5>
        <ul class="list-inline">

          
          <li>
            <a href="https://lusongsong.com/" target="_blank">卢松松博客</a>
          </li>
          
          <li>
            <a href="http://www.xldn333.com/" target="_blank"></a>
          </li>
          
          <li>
            <a href="http://www.pclrj.com/" target="_blank"></a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'ℬ'
      icon: '❡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



	<!-- Footer (contains ThemeColor、viewer) -->
	<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          
		  
		  
		  <li>
			<a target="_blank" title="微信" href="https://qiniuyun.antoniopeng.com/my_wx.png">
			  <span class="fa-stack fa-lg">
				<i class="fa fa-circle fa-stack-2x"></i>
				<i class="fa fa-stack-1x fa-inverse" style="display: inline-block; width: 28x; height: 28px; background: url('https://qiniuyun.antoniopeng.com/wx02.png') no-repeat;margin: 15px 0px 0px 15px"></i>
			  </span>
			</a>
		  </li>
		  

          

          

          

          
		  
		  
		  <li>
			<a target="_blank" title="CSDN" href="https://blog.csdn.net/monianqing">
			  <span class="fa-stack fa-lg">
				<i class="fa fa-circle fa-stack-2x"></i>
				<i class="fa fa-stack-1x fa-inverse" style="display: inline-block; width: 24px; height: 24px; background: url('https://qiniuyun.antoniopeng.com/csdn (2).png') no-repeat;margin: 15px 0px 0px 15px"></i>
			  </span>
			</a>
		  </li>
		  

          
		  
		  		
		  <li>
			<a target="_blank" title="博客园" href="https://www.cnblogs.com/antoniopeng">
			  <span class="fa-stack fa-lg">
				<i class="fa fa-circle fa-stack-2x"></i>
				<i class="fa fa-stack-1x fa-inverse" style="display: inline-block; width: 24px; height: 24px; background: url('https://qiniuyun.antoniopeng.com/bokeyuan2.png') no-repeat;margin: 15px 0px 0px 15px"></i>
			  </span>
			</a>
		  </li>
		  
		  
		  
            <li>
              <a target="_blank" title="GitHub" href="https://github.com/antoniopeng">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          
		  
		  

        </ul>
		
                <p class="copyright text-muted">
    				<a href="http://beian.miit.gov.cn" target="_blank">粤ICP备19161098号-2</a>
    				<br>
    				Copyright &copy; <a href="https://antoniopeng.com">彭超</a> 2021
    				<!--<br>
    				Powered by <a href="https://hexo.io/zh-cn/" target="_blank">Hexo</a> | Theme by <a href="http://beantech.org/" target="_blank">BeanTech</a>-->
                </p>
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>

<!-- jQuery -->
<script type="text/javascript" src="/js/jquery.min.js"></script>
<!-- <script type="text/javascript" src="/js/jquery.js"></script> -->
<!-- <script type="text/javascript" src="//cdnjs.loli.net/ajax/libs/jquery/3.2.1/jquery.min.js"></script> -->

<!-- Bootstrap Core JavaScript -->
<script type="text/javascript" src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script type="text/javascript" src="/js/hux-blog.min.js"></script>

<!-- catalog -->
<script type="text/javascript" async="true" src="/js/catalog.js?v=1.0.0"></script>

<!-- totop(rocket) -->
<script type="text/javascript" async="true" src="/js/totop.js?v=1.0.0"></script>

<!-- Busuanzi JavaScript -->
<script type="text/javascript" async="true" src="/js/busuanzi.pure.mini.js"></script>


  <!-- Scroll start -->
  <script type="text/javascript" src="/js/scroll.js"></script>
  <!-- Scroll end -->



  <!-- ThemeColor start -->
  <script type="text/javascript" src="/js/themecolor.js"></script>
  <!-- ThemeColor end -->





  <!-- viewer start -->
  <!-- viewer start (Picture preview) -->
  <script type="text/javascript" src="/js/viewer/viewer.min.js"></script>
  <script type="text/javascript" src="/js/viewer/pic-viewer.js"></script>
  <!-- viewer end -->


<script>
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
    }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){ hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if($('#tag_cloud').length !== 0){ async("https://antoniopeng.com/js/jquery.tagcloud.js",function(){ $.fn.tagcloud.defaults = { //size: {start: 1, end: 1, unit: 'em'}, color: {start:
'#bbbbee', end: '#0085a1'}, }; $('#tag_cloud a').tagcloud(); }) } </script> -->


	<!-- Search -->
	
	<div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="Search..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  <script src="/js/ziploader.js"></script>
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;

            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


	

	<!-- Image to hack wechat -->
	<!-- <img src="https://antoniopeng.com/img/icon_wechat.png" width="0" height="0" /> -->
	<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
